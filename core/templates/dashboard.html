{% extends 'base.html' %}

{% block title %}Collector Dashboard{% endblock %}

{% block content %}
{% load static %}

<style>
    body {
        background-image: url("{% static 'core/images/theme.png' %}");
        background-size: cover; /* Makes image fill the page */
        background-repeat: no-repeat;
        background-attachment: fixed; /* Keeps it in place when scrolling */
        background-position: center;
    }
    .dashboard-container {
        max-width: 1000px;
        margin: 40px auto;
        background: #ffffff;
        padding: 25px;
        border-radius: 10px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        font-family: Arial, sans-serif;
    }
    h2 img {
        height: 70px;
        vertical-align: middle;
        margin-right: 8px;
    }
    .filter-form {
        display: flex;
        flex-wrap: wrap;
        gap: 15px;
        margin-bottom: 25px;
        align-items: flex-end;
    }
    .filter-form .form-group {
        flex: 1;
        min-width: 200px;
    }
    .filter-form label {
        font-weight: bold;
        font-size: 14px;
        display: block;
        margin-bottom: 5px;
        color: #555;
    }
    .filter-form input,
    .filter-form select {
        width: 100%;
        padding: 10px;
        border: 1px solid #ccc;
        border-radius: 6px;
        font-size: 14px;
    }
    .filter-form .btn {
        padding: 10px 20px;
        background: #007bff;
        color: white;
        border: none;
        border-radius: 6px;
        cursor: pointer;
    }
    .filter-form .btn:hover {
        background: #0056b3;
    }
    .styled-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 15px;
        font-size: 14px;
    }
    .styled-table thead tr {
        background-color: #007bff;
        color: white;
        text-align: left;
    }
    .styled-table th,
    .styled-table td {
        padding: 12px 15px;
        border: 1px solid #ddd;
    }
    .styled-table tbody tr:nth-child(even) {
        background-color: #f9f9f9;
    }
    .styled-table tbody tr:hover {
        background-color: #f1f1f1;
    }
    .no-data {
        text-align: center;
        padding: 20px;
        color: #777;
    }
    .charts-container {
        margin-top: 40px;
        display: flex;
        flex-wrap: wrap;
        gap: 30px;
        justify-content: center;
    }
    canvas {
        background: #fff;
        padding: 20px;
        border-radius: 10px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        max-width: 600px;
        width: 100%;
    }
    
    body {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        background-color: #f4f6f8;
        margin: 0;
        padding: 0;
    }

    .dashboard-container {
        max-width: 1000px;
        margin: 40px auto;
        background-color: #ffffff;
        padding: 30px;
        border-radius: 12px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    h2 {
        font-size: 28px;
        color: #2c3e50;
        margin-bottom: 30px;
        text-align: center;
    }

    .metrics-grid {
        display: flex;
        flex-wrap: wrap;
        gap: 20px;
        justify-content: center;
    }

    .metric-card {
        flex: 1 1 250px;
        background-color: #fafafa;
        border: 1px solid #e0e0e0;
        border-radius: 10px;
        padding: 20px;
        text-align: center;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.05);
        transition: transform 0.2s ease;
    }

    .metric-card:hover {
        transform: translateY(-5px);
    }

    .metric-title {
        font-size: 16px;
        color: #7f8c8d;
        margin-bottom: 10px;
    }

    .metric-value {
        font-size: 24px;
        color: #27ae60;
        font-weight: bold;
    }

    #analyticsChart {
        margin-top: 40px;
        height: 400px;
        background: linear-gradient(to right, #e0f7fa, #f1f8e9);
        border: 1px solid #dcdcdc;
        border-radius: 8px;
        box-shadow: inset 0 0 10px rgba(0, 0, 0, 0.05);
    }
</style>
<div class="dashboard-container">
<h2>
        <img src="{% static 'core/images/cropped.png' %}" alt="Business Logo">
        Analytic Metrics
    </h2>

<div class="metrics-grid">
    <div class="metric-card">
        <div class="metric-title">Total Revenue</div>
        <div class="metric-value">GH‚Çµ{{ total_revenue }}</div>
    </div>
    <div class="metric-card">
        <div class="metric-title">Average Daily Revenue</div>
        <div class="metric-value">GH‚Çµ{{ avg_daily|floatformat:2 }}</div>
    </div>
    <div class="metric-card">
        <div class="metric-title">Top Collector</div>
        <div class="metric-value">
            {{ top_collector.collector__username }}<br>
            <small>(GH‚Çµ{{ top_collector.total }})</small>
        </div>
    </div>
</div>

<div class="metrics-grid">
    <div class="metric-card">
        <div class="metric-title">Total Payments</div>
        <div class="metric-value">{{ total_payments_count }}</div>
    </div>
    <div class="metric-card">
        <div class="metric-title">Avg Payment (You)</div>
        <div class="metric-value">GH‚Çµ{{ collector_avg_payment|floatformat:2 }}</div>
    </div>
    <div class="metric-card">
        <div class="metric-title">Peak Collection Day</div>
        <div class="metric-value">
            {{ peak_day.date__date }}<br>
            <small>(GH‚Çµ{{ peak_day.total }})</small>
        </div>
    </div>
    <div class="metric-card">
        <div class="metric-title">Most Used Method</div>
        <div class="metric-value">{{ most_used_method.method|capfirst }} ({{ most_used_method.count }})</div>
    </div>
    <div class="metric-card">
        <div class="metric-title">Your Contribution</div>
        <div class="metric-value">{{ collector_contribution_pct|floatformat:1 }}%</div>
    </div>
    <div class="metric-card">
        <div class="metric-title">Your Target Progress</div>
        <div class="metric-value">GH‚Çµ{{ collector_total }} / {{ collector_target }}</div>
        <div class="progress" style="height: 20px; background-color: #e9ecef; border-radius: 5px; overflow: hidden;">
            <div style="
                width: {{ collector_progress_pct }}%;
                background-color: {% if collector_progress_pct >= 100 %}#28a745{% elif collector_progress_pct >= 75 %}#ffc107{% else %}#dc3545{% endif %};
                height: 100%;
                text-align: center;
                color: white;
                font-weight: bold;
                line-height: 20px;">
                {{ collector_progress_pct|floatformat:1 }}%
            </div>
        </div>
        {% if collector_progress_pct < 75 %}
            <div style="margin-top: 5px; color: #dc3545; font-size: 0.9em;">
                ‚ö†Ô∏è You are below target. Keep pushing!
            </div>
        {% endif %}
    </div>

    <!-- üîπ Daily Target Tracker -->
    <div class="metric-card">
        <div class="metric-title">Today‚Äôs Collection</div>
        <div class="metric-value">GH‚Çµ{{ today_total }} / {{ collector_target }}</div>
        <div class="progress" style="height: 20px; background-color: #e9ecef; border-radius: 5px; overflow: hidden;">
            <div style="
                width: {{ today_progress_pct }}%;
                background-color: {% if today_progress_pct >= 100 %}#28a745{% elif today_progress_pct >= 75 %}#ffc107{% else %}#dc3545{% endif %};
                height: 100%;
                text-align: center;
                color: white;
                font-weight: bold;
                line-height: 20px;">
                {{ today_progress_pct|floatformat:1 }}%
            </div>
        </div>
    </div>

    <!-- üî• Streak Counter -->
    <div class="metric-card">
        <div class="metric-title">Streak</div>
        <div class="metric-value">
            {% if streak >= 3 %}
                üî• {{ streak }}-day streak!
            {% else %}
                {{ streak }} day{{ streak|pluralize }} above target
            {% endif %}
        </div>
    </div>

    <!-- üèÖ Milestone Badges -->
    <div class="metric-card">
        <div class="metric-title">Milestones</div>
        <div class="metric-value">
            {% if milestones %}
                {% for badge in milestones %}
                    <span style="background-color: #28a745; color: white; padding: 4px 8px; border-radius: 4px; margin-right: 4px;">{{ badge }}</span>
                {% endfor %}
            {% else %}
                No milestones yet
            {% endif %}
        </div>
    </div>

        
    <div class="metric-card">
        <div class="metric-title">Global Rank</div>
        <div class="metric-value">
                
        {% if peer_rank %}
            <div class="badge-highlight">
                üéñÔ∏è You're ranked <strong>#{{ peer_rank }}</strong> out of {{ peer_total }} collectors!
            </div>
        {% endif %}
        </div>
    </div>

    <!-- üìä Peer Comparison -->
        
    <div class="metric-card">
        <div class="metric-title">Global Rank</div>
        <div class="metric-value">
            {% if peer_rank %}
                You‚Äôre #{{ peer_rank }} of {{ peer_total }} collectors
            {% else %}
                Not ranked
            {% endif %}
        </div>
    </div>
</div>


<canvas id="peerChart" height="120"></canvas>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    const ctx = document.getElementById('peerChart').getContext('2d');
    const peerChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: {{ peer_labels|safe }},
            datasets: [{
                label: 'Total Collected',
                data: {{ peer_values|safe }},
                backgroundColor: {{ peer_labels|safe }}.map(name =>
                    name === "{{ request.user.username }}" ? '#007bff' : '#6c757d'
                ),
                borderColor: {{ peer_labels|safe }}.map(name =>
                    name === "{{ request.user.username }}" ? '#ffc107' : '#6c757d'
                ),
                borderWidth: {{ peer_labels|safe }}.map(name =>
                    name === "{{ request.user.username }}" ? 3 : 1
                ),
            }]
        },
        options: {
            animation: {
                duration: 1200,
                easing: 'easeOutBounce'
            },
            responsive: true,
            plugins: {
                legend: { display: false },
                tooltip: { mode: 'index', intersect: false }
            },
            scales: {
                y: { beginAtZero: true }
            }
        }
    });
</script>






<div class="dashboard-container">
    <h2>
        <img src="{% static 'core/images/cropped.png' %}" alt="Business Logo">
        Collector Dashboard
    </h2>

    <!-- Filter Form -->
    <form method="get" class="filter-form">
        <div class="form-group">
            <label for="start_date">Start Date:</label>
            <input type="date" name="start_date" value="{{ start_date }}">
        </div>
        <div class="form-group">
            <label for="end_date">End Date:</label>
            <input type="date" name="end_date" value="{{ end_date }}">
        </div>
        <div class="form-group">
            <label for="method">Payment Method:</label>
            <select name="method">
                <option value="">All</option>
                <option value="mobile_money" {% if method == 'mobile_money' %}selected{% endif %}>Mobile Money</option>
                <option value="cash" {% if method == 'cash' %}selected{% endif %}>Cash</option>
            </select>
        </div>
        <button type="submit" class="btn">Filter</button>
    </form>

    <!-- Payments Table -->
    <table class="styled-table">
        <thead>
            <tr>
                <th>Business</th>
                <th>Amount (GHS)</th>
                <th>Method</th>
                <th>Receipt ID</th>
                <th>Date</th>
            </tr>
        </thead>
        <tbody>
            {% for payment in payments %}
            <tr>
                <td>{{ payment.business.name }}</td>
                <td>{{ payment.amount }}</td>
                <td>{{ payment.get_method_display }}</td>
                <td>{{ payment.receipt_id }}</td>
                <td>{{ payment.date|date:"Y-m-d H:i" }}</td>
            </tr>
            {% empty %}
            <tr>
                <td colspan="5" class="no-data">No payments found.</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <!-- Charts -->
    <div class="charts-container">
        <canvas id="revenueChart"></canvas>
        <canvas id="collectorRevenueChart"></canvas>
    </div>
</div>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<canvas id="revenueChart"></canvas>

<script>
    const ctx = document.getElementById('revenueChart').getContext('2d');
    const chart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: {{ labels|safe }},
            datasets: [{
                label: 'Revenue Over Time',
                data: {{ data|safe }},
                borderColor: 'rgba(75, 192, 192, 1)',
                backgroundColor: 'rgba(75, 192, 192, 0.2)',
                borderWidth: 2,
                fill: true,
                tension: 0.3
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: { display: true },
                title: {
                    display: true,
                    text: 'Daily Revenue'
                }
            }
        }
    });
</script>

{% endblock %}



